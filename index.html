<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - BeaBoo</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-pap6t+K2bD6xIxQqkQ3sM8e+RXw7C3DyrgXV++o2aL/88+/9kS/l+SmpD8zZR1oN40Nq3QfT7HigDYfFW1zZAQ==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Firebase (compat): app, auth, database y storage -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // Configuración de Firebase (ajusta según tu proyecto)
    const firebaseConfig = {
      apiKey: "AIzaSyA1UV_OTjRjq22RRB1REnhWzMLZQNCB6wA",
      authDomain: "love-alarm-5c538.firebaseapp.com",
      databaseURL: "https://love-alarm-5c538-default-rtdb.firebaseio.com",
      projectId: "love-alarm-5c538",
      storageBucket: "love-alarm-5c538.appspot.com",
      messagingSenderId: "147543369973",
      appId: "1:147543369973:web:3ef19a73190bce85b27dbc",
      measurementId: "G-VYVPK5VSB5"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: 'Nunito', sans-serif; }
    /* CABECERA FIJA */
    header {
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0.75rem 1rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
    }
    /* Barra de pestañas (navegación horizontal) */
    nav.tabs {
      display: flex;
      overflow-x: auto;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: #f3f4f6;
    }
    nav.tabs button {
      flex: none;
      white-space: nowrap;
    }
    /* Contenedor principal para el dashboard */
    #adminDashboardMain {
      margin-top: 120px; /* espacio para header y pestañas */
    }
    /* Tarjetas (cards) para cada sección */
    .card {
      background-color: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }
    /* Spinner estilo TikTok */
    .spinner-tiktok {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    .spinner-tiktok div {
      position: absolute;
      border: 4px solid #58CC02;
      opacity: 1;
      border-radius: 50%;
      animation: spinner-tiktok 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
    }
    .spinner-tiktok div:nth-child(2) {
      animation-delay: -0.5s;
    }
    @keyframes spinner-tiktok {
      0% { transform: scale(0); }
      50% { transform: scale(1); opacity: 0.5; }
      100% { transform: scale(0); opacity: 0; }
    }
    /* Modal de respuesta (Reply Modal) */
    #replyModal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #replyModal .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    /* Modal para administrar historias de un autor */
    #storiesModal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #storiesModal .modal-content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      width: 95%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    /* Estilo Duolingo para el modal de registro/inicio de sesión */
    .duolingo-modal {
      background: linear-gradient(135deg, #4CAF50, #8BC34A);
      color: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .duolingo-modal input,
    .duolingo-modal button {
      border: none;
      padding: 0.75rem;
      border-radius: 9999px;
      margin-top: 1rem;
    }
    .duolingo-modal input {
      width: 100%;
    }
    .duolingo-modal button {
      background-color: white;
      color: #4CAF50;
      font-weight: bold;
      width: 100%;
    }
    /* Mensaje para historias bloqueadas */
    .blocked-story {
      background-color: #f2f2f2;
      color: #888;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: bold;
    }
    /* Para que los modales del dashboard se muestren en primer plano */
    #adminDashboard, #adminAuthModal { z-index: 50; }
    /* NUEVA SECCIÓN: REGALOS LIVE */
    nav.tabs button.giftsTabBtn {
      background-color: #ccc;
      color: #333;
    }
    #giftsTab {
      padding: 1rem;
    }
    #giftForm input,
    #giftForm button {
      margin-top: 0.75rem;
    }
    #giftList .card {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    /* Estilo para el Gift Drawer (drawer de regalos que se desliza desde abajo) */
    #gift-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background-color: #fff;
      overflow: hidden;
      transition: height 0.4s ease;
      z-index: 10000;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
    }
    #gift-drawer.open {
      height: 50vh;
    }
    #gift-drawer .gift-container {
      padding: 20px;
    }
    #gift-drawer .gift-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 10px;
      text-align: center;
    }
    #gift-drawer .gift-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    #gift-drawer .gift-item span {
      font-size: 0.8rem;
      margin-top: 4px;
      display: block;
    }
    /* Estilo para la animación de regalo (overlay) */
    #gift-animation {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 11000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #gift-animation.show {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- PANTALLA DE INTRO Y REGISTRO/LOGIN -->
  <div id="adminIntro" class="min-h-screen flex flex-col items-center justify-center relative">
    <img src="https://ideogram.ai/assets/image/lossless/response/Mj2UkJSlRUi5-nusIdo7CA" alt="Intro" class="absolute inset-0 w-full h-full object-cover opacity-50">
    <div class="duolingo-modal max-w-md mx-auto z-10">
      <h2 class="text-3xl font-bold mb-4 text-center">Bienvenido al Panel de Administración</h2>
      <form id="adminRegisterForm" class="space-y-4">
        <input type="email" id="adminRegEmail" placeholder="Correo electrónico" required>
        <input type="password" id="adminRegPassword" placeholder="Contraseña" required>
        <button type="submit">Registrarse</button>
      </form>
      <p class="mt-4 text-center">¿Ya tienes cuenta? <a href="#" onclick="toggleAdminAuth()" class="underline">Inicia sesión</a></p>
    </div>
  </div>
  
  <!-- Modal de inicio de sesión (Duolingo style) -->
  <div id="adminAuthModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="duolingo-modal max-w-md mx-auto">
      <h2 class="text-3xl font-bold mb-4 text-center">Iniciar Sesión</h2>
      <form id="adminAuthForm" class="space-y-4">
        <input type="email" id="adminAuthEmail" placeholder="Correo electrónico" required>
        <input type="password" id="adminAuthPassword" placeholder="Contraseña" required>
        <button type="submit">Iniciar Sesión</button>
      </form>
      <p class="mt-4 text-center">¿No tienes cuenta? <a href="#" onclick="toggleAdminAuth()" class="underline">Regístrate</a></p>
    </div>
  </div>
  
  <!-- DASHBOARD DEL ADMIN (se muestra después del login) -->
  <div id="adminDashboard" class="hidden">
    <!-- CABECERA FIJA -->
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Panel de Administración</h1>
      <button onclick="adminSignOut()" class="bg-red-500 text-white px-3 py-2 rounded flex items-center">
        <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
      </button>
    </header>
    <!-- Barra de pestañas -->
    <nav class="tabs mt-20">
      <button class="admin-tab px-4 py-2 bg-[#58CC02] text-white rounded" onclick="showTab('reports', event)">
        <i class="fas fa-flag mr-1"></i> Reportes
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('support', event)">
        <i class="fas fa-headset mr-1"></i> Soporte
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('users', event)">
        <i class="fas fa-user-slash mr-1"></i> Bloqueados
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('verify', event)">
        <i class="fas fa-check-circle mr-1"></i> Verificación
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('stories', event)">
        <i class="fas fa-book mr-1"></i> Historias
      </button>
      <button class="admin-tab giftsTabBtn px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('gifts', event)">
        <i class="fas fa-gift mr-1"></i> Regalos Live
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('profile', event)">
        <i class="fas fa-user mr-1"></i> Perfil
      </button>
    </nav>
    <!-- Contenido principal del dashboard -->
    <main id="adminDashboardMain" class="container mx-auto px-4">
      <!-- Sección Reportes -->
      <section id="reportsTab" class="admin-tab-content">
        <h2 class="text-2xl font-bold mb-4">Reportes Recibidos</h2>
        <div id="reportsList" class="space-y-4"></div>
      </section>
      <!-- Sección Soporte -->
      <section id="supportTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Solicitudes de Soporte</h2>
        <div id="supportList" class="space-y-4"></div>
      </section>
      <!-- Sección Usuarios Bloqueados -->
      <section id="usersTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Usuarios Bloqueados</h2>
        <div id="blockedUsersList" class="space-y-4"></div>
      </section>
      <!-- Sección Verificación -->
      <section id="verifyTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Verificar Usuario</h2>
        <div class="mb-4">
          <input type="text" id="verifyUserId" placeholder="Ingrese ID del usuario" class="w-full p-3 border rounded">
        </div>
        <button onclick="executeWithSpinner(function(){ verifyUser(); })" class="w-full bg-blue-500 text-white p-3 rounded flex items-center justify-center">
          <i class="fas fa-check-circle mr-2"></i> Marcar como Verificado
        </button>
        <div id="verifiedUsersList" class="mt-6"></div>
      </section>
      <!-- Sección Historias de Autores -->
      <section id="storiesTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Historias por Autor</h2>
        <div id="authorsList" class="space-y-4"></div>
      </section>
      <!-- Sección Regalos Live -->
      <section id="giftsTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Administrar Regalos Live</h2>
        <div class="card mb-4">
          <h3 class="text-xl font-bold mb-2">Subir Nuevo Regalo</h3>
          <form id="giftForm" class="space-y-4">
            <input type="text" id="giftTitle" placeholder="Título del regalo" class="w-full p-3 border rounded">
            <input type="number" id="giftPrice" placeholder="Precio en monedas (0 para gratis)" min="0" class="w-full p-3 border rounded">
            <input type="file" id="giftFile" accept="image/*,video/*,image/svg+xml" class="w-full p-3 border rounded">
            <button type="submit" class="w-full bg-[#58CC02] text-white p-3 rounded flex items-center justify-center">
              <i class="fas fa-upload mr-2"></i> Publicar Regalo
            </button>
          </form>
        </div>
        <div id="giftList" class="space-y-4"></div>
      </section>
      <!-- Sección Perfil del Administrador -->
      <section id="profileTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Perfil del Administrador</h2>
        <div class="card flex flex-col items-center">
          <img id="adminProfilePic" src="https://via.placeholder.com/150" alt="Foto de perfil" class="w-24 h-24 rounded-full mb-4">
          <h3 id="adminProfileEmail" class="text-xl font-bold"></h3>
          <div class="flex items-center mt-2">
            <img src="https://cdn-icons-png.flaticon.com/512/5776/5776691.png" alt="Puntos" class="w-6 h-6 mr-2" />
            <span id="adminProfilePoints" class="text-lg"></span> puntos
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- MODAL DE RESPUESTA (Reply Modal) -->
  <div id="replyModal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">Enviar Respuesta</h2>
      <textarea id="replyMessage" placeholder="Escribe tu respuesta aquí..." class="w-full border p-2 rounded mb-4" rows="5"></textarea>
      <div class="flex justify-end">
        <button onclick="executeWithSpinner(function(){ closeReplyModal(); })" class="mr-4 bg-gray-500 text-white px-4 py-2 rounded flex items-center">
          <i class="fas fa-times-circle mr-1"></i> Cancelar
        </button>
        <button onclick="executeWithSpinner(function(){ sendReply(); })" class="bg-[#58CC02] text-white px-4 py-2 rounded flex items-center">
          <i class="fas fa-paper-plane mr-1"></i> Enviar
        </button>
      </div>
    </div>
  </div>
  
  <!-- MODAL PARA ADMINISTRAR HISTORIAS DE UN AUTOR -->
  <div id="storiesModal" class="hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h2 id="modalAuthorName" class="text-2xl font-bold">Historias de [Autor]</h2>
        <button onclick="executeWithSpinner(function(){ closeStoriesModal(); })" class="text-gray-500 text-3xl">&times;</button>
      </div>
      <div id="authorStoriesList" class="space-y-4"></div>
    </div>
  </div>
  
  <!-- SPINNER DE CARGA (TikTok Style) -->
  <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="spinner-tiktok">
      <div></div>
      <div></div>
    </div>
  </div>
  
  <!-- MODAL DE TRANSMISIÓN EN VIVO (para el autor) -->
  <div id="live-stream-modal" class="fixed inset-0 bg-white z-50 hidden">
    <div class="relative w-full h-full">
      <div id="live-viewCount" class="absolute top-4 left-4 text-xl text-[#58CC02]">0 vistas</div>
      <video id="live-localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
      <div id="live-overlay" class="absolute inset-0 flex flex-col items-center justify-center">
        <div id="live-countdown" class="text-6xl font-bold text-[#58CC02]"></div>
        <div id="live-indicator" class="hidden text-4xl font-bold text-red-600">EN VIVO</div>
      </div>
      <button id="live-startBtn" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-2xl rounded-full p-6"></button>
      <button id="live-endBtn" class="absolute top-4 right-4 bg-gray-800 text-white text-lg rounded p-2 hidden">
        Finalizar transmisión
      </button>
      <button id="live-closeBtn" onclick="closeLiveStreamModal()" class="absolute top-4 left-4 bg-gray-800 text-white text-lg rounded p-2">
        X
      </button>
    </div>
  </div>
  
  <!-- MODAL DE VISUALIZACIÓN EN VIVO (para espectadores) -->
  <div id="live-view-modal" class="fixed inset-0 bg-white z-50 hidden">
    <div class="relative w-full h-full">
      <video id="live-remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
      <button id="live-view-closeBtn" class="absolute top-4 left-4 bg-gray-800 text-white text-lg rounded p-2">Cerrar</button>
      <div id="live-endedMessage" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-gray-800 hidden">
        La transmisión ha terminado.<br>Revisa otras transmisiones en vivo.
      </div>
      <button id="gift-btn" class="absolute bottom-4 right-4 bg-transparent">
        <img src="https://cdn-icons-png.flaticon.com/512/5899/5899678.png" alt="Regalo" class="w-10 h-10">
      </button>
    </div>
  </div>
  
  <!-- GIFT DRAWER (drawer de regalos que se desliza desde abajo) -->
  <div id="gift-drawer">
    <div class="gift-container">
      <h2 class="text-xl font-bold mb-4 text-center">Enviar Regalo</h2>
      <div class="gift-grid">
        <!-- Ejemplo: Regalos predefinidos -->
        <div class="gift-item" onclick="sendGift('mariposas')">
          <img src="https://i.pinimg.com/originals/7c/29/36/7c2936db7563085ef7470d50fd06e4e3.gif" alt="Mariposas de Cielo">
          <span>Mariposas de Cielo</span>
        </div>
        <div class="gift-item" onclick="sendGift('ballena')">
          <img src="https://i.pinimg.com/originals/86/31/83/863183316ed35cfeda7baf9ee1de0596.gif" alt="Ballena Negra">
          <span>Ballena Negra</span>
        </div>
      </div>
      <button onclick="closeGiftDrawer()" class="mt-4 bg-gray-300 text-black p-2 rounded w-full">Cancelar</button>
    </div>
  </div>
  
  <!-- Contenedor para la animación del regalo (overlay) -->
  <div id="gift-animation"></div>
  
  <script>
    /********** VARIABLES GLOBALES ADMIN **********/
    let replyTargetUser = null;
    let replyContext = "";
    let currentAuthorForStories = null;
    let currentLanguage = 'es';
    
    const translations = {
      es: {
        appName: "BeaBoo",
        tagline: "Tu portal de historias inolvidables",
        authTitle: "BeaBoo",
        emailPlaceholder: "Correo electrónico",
        passwordPlaceholder: "Contraseña",
        btnIniciarSesion: "Iniciar Sesión",
        btnToggleAuth: "¿No tienes cuenta? Regístrate",
        btnVolver: "Volver",
        newReleases: "Nuevos Lanzamientos",
        top10: "Top 10",
        popular: "Más Populares",
        terror: "Historias de Terror Destacadas",
        searchPlaceholder: "Buscar historias o autores",
        searchResults: "Resultados de búsqueda",
        searchBooks: "Libros",
        searchAuthors: "Autores",
        profileStories: "Mis Historias",
        editProfile: "Editar nombre",
        saveBio: "Guardar biografía",
        createStory: "Crear Historia",
        storyTitlePlaceholder: "Título de la historia",
        selectCategory: "Selecciona una categoría",
        btnCreateStory: "Crear Historia",
        editStory: "Editar Historia",
        addChapter: "Agregar Capítulo",
        deleteStory: "Eliminar Historia",
        makePrivate: "Hacer privada",
        chapterCreationTitle: "Agregar Nuevo Capítulo",
        chapterPlaceholder: "Escribe el contenido del capítulo aquí...",
        btnSaveChapter: "Guardar Capítulo",
        readChapter: "Capítulo",
        btnPrevChapter: "Anterior",
        btnNextChapter: "Siguiente",
        rateChapter: "Califica:",
        authorProfile: "Por",
        reportProfile: "Reportar Perfil",
        reportInstructions: "Selecciona un motivo o describe el problema:",
        btnSendReport: "Enviar Reporte",
        reportSuccess: "Reporte enviado con éxito. En breve recibirás una respuesta.",
        noInfraccion: "No se detectaron infracciones en este perfil.",
        followers: "Seguidores",
        following: "Siguiendo",
        ratings: "Calificaciones",
        languageModalTitle: "Selecciona tu idioma",
        editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
        usernameUpdated: "Nombre de usuario actualizado.",
        bioUpdated: "Biografía actualizada.",
        chapterAdded: "Capítulo agregado.",
        noEditingStory: "No hay historia en edición.",
        userNotAuthenticated: "Usuario no autenticado.",
        chapterNotFound: "Capítulo no encontrado.",
        firstChapter: "Este es el primer capítulo.",
        lastChapter: "Este es el último capítulo.",
        chapterRated: "Capítulo calificado con {value} estrella(s).",
        followSelfError: "No puedes seguirte a ti mismo.",
        nowFollowing: "Ahora sigues a este autor.",
        stoppedFollowing: "Has dejado de seguir a este autor.",
        alreadyFollowing: "Ya sigues a este usuario.",
        storyDeleted: "Historia eliminada.",
        editLater: "Puedes editar tu historia más tarde desde tu perfil."
      },
      en: {
        appName: "BeaBoo",
        tagline: "Your portal to unforgettable stories",
        authTitle: "BeaBoo",
        emailPlaceholder: "Email",
        passwordPlaceholder: "Password",
        btnIniciarSesion: "Log In",
        btnToggleAuth: "Don't have an account? Sign Up",
        btnVolver: "Back",
        newReleases: "New Releases",
        top10: "Top 10",
        popular: "Most Popular",
        terror: "Featured Horror Stories",
        searchPlaceholder: "Search stories or authors",
        searchResults: "Search Results",
        searchBooks: "Books",
        searchAuthors: "Authors",
        profileStories: "My Stories",
        editProfile: "Edit Story",
        saveBio: "Save Bio",
        createStory: "Create Story",
        storyTitlePlaceholder: "Story Title",
        selectCategory: "Select a category",
        btnCreateStory: "Create Story",
        editStory: "Edit Story",
        addChapter: "Add Chapter",
        deleteStory: "Delete Story",
        makePrivate: "Make Private",
        chapterCreationTitle: "Add New Chapter",
        chapterPlaceholder: "Write the chapter content here...",
        btnSaveChapter: "Save Chapter",
        readChapter: "Chapter",
        btnPrevChapter: "Previous",
        btnNextChapter: "Next",
        rateChapter: "Rate:",
        authorProfile: "By",
        reportProfile: "Report Profile",
        reportInstructions: "Select a reason or describe the problem:",
        btnSendReport: "Send Report",
        reportSuccess: "Report sent successfully. You will receive a response shortly.",
        noInfraccion: "No infringement was detected in this profile.",
        followers: "Followers",
        following: "Following",
        ratings: "Ratings",
        languageModalTitle: "Select your language",
        editUsernamePrompt: "Enter your new username:",
        usernameUpdated: "Username updated.",
        bioUpdated: "Biography updated.",
        chapterAdded: "Chapter added.",
        noEditingStory: "No story in edit mode.",
        userNotAuthenticated: "User not authenticated.",
        chapterNotFound: "Chapter not found.",
        firstChapter: "This is the first chapter.",
        lastChapter: "This is the last chapter.",
        chapterRated: "Chapter rated with {value} star(s).",
        followSelfError: "You cannot follow yourself.",
        nowFollowing: "You are now following this author.",
        stoppedFollowing: "You have unfollowed this author.",
        alreadyFollowing: "You are already following this user.",
        storyDeleted: "Story deleted.",
        editLater: "You can edit your story later from your profile."
      }
      // (Se puede agregar la versión pt si se requiere)
    };
    
    function updateTranslations() {
      document.getElementById('app-name').innerText = translations[currentLanguage].appName;
      document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
      document.getElementById('auth-title').innerText = translations[currentLanguage].authTitle;
      emailInput.placeholder = translations[currentLanguage].emailPlaceholder;
      passwordInput.placeholder = translations[currentLanguage].passwordPlaceholder;
      submitButton.innerText = translations[currentLanguage].btnIniciarSesion;
      toggleAuth.innerText = translations[currentLanguage].btnToggleAuth;
      document.getElementById('btn-volver-search').innerText = translations[currentLanguage].btnVolver;
      document.getElementById('btn-volver-profile').innerText = translations[currentLanguage].btnVolver;
      document.getElementById('btn-volver-author').innerText = translations[currentLanguage].btnVolver;
      document.getElementById('new-releases-title').innerText = translations[currentLanguage].newReleases;
      document.getElementById('top10-title').innerText = translations[currentLanguage].top10;
      document.getElementById('popular-title').innerText = translations[currentLanguage].popular;
      document.getElementById('terror-title').innerText = translations[currentLanguage].terror;
      document.getElementById('search-input').placeholder = translations[currentLanguage].searchPlaceholder;
      document.getElementById('search-results-title').innerText = translations[currentLanguage].searchResults;
      document.getElementById('search-books-title').innerText = translations[currentLanguage].searchBooks;
      document.getElementById('search-authors-title').innerText = translations[currentLanguage].searchAuthors;
      document.getElementById('profile-stories-title').innerText = translations[currentLanguage].profileStories;
      document.getElementById('story-type-title').innerText = translations[currentLanguage].createStory;
      document.getElementById('create-story-title').innerText = translations[currentLanguage].createStory;
      document.getElementById('story-title').placeholder = translations[currentLanguage].storyTitlePlaceholder;
      document.getElementById('story-category').options[0].text = translations[currentLanguage].selectCategory;
      document.getElementById('btn-create-story').innerText = translations[currentLanguage].btnCreateStory;
      document.getElementById('edit-story-title').innerText = translations[currentLanguage].editStory;
      document.getElementById('chapter-creation-title').innerText = translations[currentLanguage].chapterCreationTitle;
      document.getElementById('chapter-content').placeholder = translations[currentLanguage].chapterPlaceholder;
      document.getElementById('btn-save-chapter').innerText = translations[currentLanguage].btnSaveChapter;
      document.getElementById('prev-chapter-btn').innerText = translations[currentLanguage].btnPrevChapter;
      document.getElementById('next-chapter-btn').innerText = translations[currentLanguage].btnNextChapter;
      document.getElementById('detail-synopsis').innerText = "Sinopsis de la historia...";
      document.getElementById('detail-metrics').innerHTML =
        `<span><strong>0</strong> Visitas</span>
         <span><strong>0</strong> ${translations[currentLanguage].ratings}</span>
         <span><strong>0</strong> Capítulos</span>`;
      document.getElementById('report-title').innerText = translations[currentLanguage].reportProfile;
      document.getElementById('report-instructions').innerText = translations[currentLanguage].reportInstructions;
      document.getElementById('btn-enviar-report').innerText = translations[currentLanguage].btnSendReport;
      document.getElementById('lang-modal-title').innerText = translations[currentLanguage].languageModalTitle;
    }
    
    function setLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem("selectedLanguage", lang);
      // Aquí se podría mostrar un overlay de carga
      setTimeout(() => {
        updateTranslations();
      }, 1000);
    }
    
    window.addEventListener('load', () => {
      setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if(splash) {
          splash.style.opacity = '0';
          setTimeout(() => { splash.style.display = 'none'; }, 1000);
        }
      }, 3000);
    });
    
    /********** ADMIN LOGIN/REGISTRO Y DASHBOARD **********/
    function toggleAdminAuth(){
      const intro = document.getElementById('adminIntro');
      const authModal = document.getElementById('adminAuthModal');
      if(intro.classList.contains('hidden')){
        intro.classList.remove('hidden');
        authModal.classList.add('hidden');
      } else {
        intro.classList.add('hidden');
        authModal.classList.remove('hidden');
      }
    }
    
    document.getElementById('adminRegisterForm').addEventListener('submit', function(e){
      e.preventDefault();
      const email = document.getElementById('adminRegEmail').value;
      const password = document.getElementById('adminRegPassword').value;
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          // Solo se permite el acceso a correos autorizados
          if(
            userCredential.user.email !== "darelvega6@icloud.com" &&
            userCredential.user.email !== "ponsy75@yahoo.com" &&
            userCredential.user.email !== "donovanyaztel1863@gmail.com"
          ){
            alert("Acceso denegado. Solo los administradores autorizados pueden registrarse.");
            firebase.auth().signOut();
            return;
          }
          document.getElementById('adminIntro').classList.add('hidden');
          document.getElementById('adminDashboard').classList.remove('hidden');
          loadReports();
          loadSupportRequests();
          loadBlockedUsers();
          loadAuthorsForStories();
          loadVerifiedUsers();
          initializeAdminProfile();
          loadAdminProfile();
          updateAdminPhotoFromOriginal();
          setInterval(checkAndDepositPoints, 60000);
        })
        .catch(error => {
          alert(error.message);
        });
    });
    
    document.getElementById('adminAuthForm').addEventListener('submit', function(e){
      e.preventDefault();
      const email = document.getElementById('adminAuthEmail').value;
      const password = document.getElementById('adminAuthPassword').value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          if(
            userCredential.user.email !== "darelvega6@icloud.com" &&
            userCredential.user.email !== "ponsy75@yahoo.com" &&
            userCredential.user.email !== "donovanyaztel1863@gmail.com"
          ){
            alert("Acceso denegado. No eres administrador.");
            firebase.auth().signOut();
            return;
          }
          document.getElementById('adminAuthModal').classList.add('hidden');
          document.getElementById('adminDashboard').classList.remove('hidden');
          loadReports();
          loadSupportRequests();
          loadBlockedUsers();
          loadAuthorsForStories();
          loadVerifiedUsers();
          initializeAdminProfile();
          loadAdminProfile();
          updateAdminPhotoFromOriginal();
          setInterval(checkAndDepositPoints, 60000);
        })
        .catch(error => {
          alert(error.message);
        });
    });
    
    function adminSignOut(){
      firebase.auth().signOut().then(() => {
        location.reload();
      });
    }
    
    /********** REPORTES, SOPORTE, USUARIOS, HISTORIAS Y VERIFICACIÓN **********/
    function loadReports(){
      const reportsRef = firebase.database().ref('reports');
      reportsRef.on('value', snapshot => {
        const reportsList = document.getElementById('reportsList');
        reportsList.innerHTML = "";
        snapshot.forEach(child => {
          const report = child.val();
          const reportDiv = document.createElement('div');
          reportDiv.className = "card";
          let blockButton = "";
          if(report.reason === "perfil_falso" || (!report.storyId && report.reportedUser)){
            blockButton = `<button class="bg-gray-700 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ blockProfile('${report.reportedUser}'); })">
                             <i class="fas fa-ban mr-1"></i> Bloquear Perfil
                           </button>`;
          } else if(report.storyId){ 
            blockButton = `<button class="bg-gray-700 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ blockStory('${report.storyId}'); })">
                             <i class="fas fa-ban mr-1"></i> Bloquear Historia
                           </button>`;
          }
          reportDiv.innerHTML = `
            <p><strong>Reportado:</strong> ${report.reportedName} (${report.reportedUser})</p>
            <p><strong>Reportado por:</strong> ${report.reporterName}</p>
            <p><strong>Motivo:</strong> ${report.reason}</p>
            <p><strong>Descripción:</strong> ${report.description}</p>
            <p><strong>Fecha:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
            <p><strong>Estado:</strong> ${report.status}</p>
            <div class="flex flex-wrap gap-2 mt-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ openReplyModal('${report.reporter}', 'report'); })">
                <i class="fas fa-reply mr-1"></i> Responder
              </button>
              <button class="bg-green-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ updateReportStatus('${child.key}', 'accepted'); })">
                <i class="fas fa-check-circle mr-1"></i> Aceptar
              </button>
              <button class="bg-red-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ updateReportStatus('${child.key}', 'rejected'); })">
                <i class="fas fa-times-circle mr-1"></i> Rechazar
              </button>
              ${blockButton}
            </div>
          `;
          reportsList.appendChild(reportDiv);
        });
      });
    }
    
    function updateReportStatus(reportId, newStatus){
      firebase.database().ref('reports/' + reportId).update({ status: newStatus })
        .then(() => { alert("Reporte actualizado a: " + newStatus); })
        .catch(error => { console.error("Error al actualizar reporte:", error); });
    }
    
    function loadSupportRequests(){
      const supportRef = firebase.database().ref('supportRequests');
      supportRef.on('value', snapshot => {
        const supportList = document.getElementById('supportList');
        supportList.innerHTML = "";
        snapshot.forEach(child => {
          const support = child.val();
          const supportDiv = document.createElement('div');
          supportDiv.className = "card";
          supportDiv.innerHTML = `
            <p><strong>Usuario:</strong> ${support.userId}</p>
            <p><strong>Asunto:</strong> ${support.subject}</p>
            <p><strong>Mensaje:</strong> ${support.message}</p>
            <p><strong>Fecha:</strong> ${new Date(support.timestamp).toLocaleString()}</p>
            <p><strong>Estado:</strong> ${support.status}</p>
            <div class="flex flex-wrap gap-2 mt-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ openReplyModal('${support.userId}', 'support'); })">
                <i class="fas fa-reply mr-1"></i> Responder
              </button>
              <button class="bg-green-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ updateSupportStatus('${child.key}', 'resolved'); })">
                <i class="fas fa-heart mr-1"></i> Resuelto
              </button>
            </div>
          `;
          supportList.appendChild(supportDiv);
        });
      });
    }
    
    function updateSupportStatus(requestId, newStatus){
      firebase.database().ref('supportRequests/' + requestId).update({ status: newStatus })
        .then(() => { alert("Soporte actualizado a: " + newStatus); })
        .catch(error => { console.error("Error al actualizar soporte:", error); });
    }
    
    function loadBlockedUsers(){
      const usersRef = firebase.database().ref('users');
      usersRef.orderByChild('blocked').equalTo(true).on('value', snapshot => {
        const blockedList = document.getElementById('blockedUsersList');
        blockedList.innerHTML = "";
        snapshot.forEach(child => {
          const user = child.val();
          const userDiv = document.createElement('div');
          userDiv.className = "card";
          userDiv.innerHTML = `
            <p><strong>Usuario:</strong> ${user.username} (${child.key})</p>
            <p><strong>Bloqueado hasta:</strong> ${new Date(user.blockedUntil).toLocaleString()}</p>
            <button class="bg-green-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ unblockUser('${child.key}'); })">
              <i class="fas fa-unlock mr-1"></i> Desbloquear
            </button>
          `;
          blockedList.appendChild(userDiv);
        });
      });
    }
    
    function unblockUser(userId){
      firebase.database().ref('users/' + userId).update({ blocked: false, blockedUntil: null })
        .then(() => { alert("Usuario desbloqueado"); })
        .catch(error => { console.error("Error al desbloquear usuario:", error); });
    }
    
    function blockStory(storyId){
      if(confirm("¿Seguro que deseas bloquear esta historia? Se desactivará en la plataforma.")){
        firebase.database().ref('stories/' + storyId).update({ 
          blocked: true,
          blockedMessage: "BeaBoo ha bloqueado esta historia por infringir las normas de la comunidad"
        })
          .then(() => { alert("Historia bloqueada."); })
          .catch(error => { console.error("Error al bloquear la historia:", error); });
      }
    }
    
    function blockProfile(userId){
      if(confirm("¿Seguro que deseas bloquear este perfil? El usuario quedará bloqueado en tiempo real.")){
        const blockedUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
        firebase.database().ref('users/' + userId).update({ 
          blocked: true,
          blockedUntil: blockedUntil
        })
          .then(() => { alert("Perfil bloqueado."); })
          .catch(error => { console.error("Error al bloquear el perfil:", error); });
      }
    }
    
    function openReplyModal(targetUser, context){
      replyTargetUser = targetUser;
      replyContext = context;
      document.getElementById('replyModal').style.display = "flex";
    }
    function closeReplyModal(){
      document.getElementById('replyModal').style.display = "none";
      document.getElementById('replyMessage').value = "";
      replyTargetUser = null;
      replyContext = "";
    }
    function sendReply(){
      const message = document.getElementById('replyMessage').value;
      if(!replyTargetUser || message.trim() === ""){
        alert("Escribe un mensaje para enviar.");
        return;
      }
      addNotification(replyTargetUser, message);
      alert("Respuesta enviada.");
      closeReplyModal();
    }
    
    function addNotification(userId, message) {
      const notificationsRef = firebase.database().ref('notifications/' + userId);
      const newNotificationRef = notificationsRef.push();
      newNotificationRef.set({
        message: message,
        timestamp: Date.now(),
        read: false
      });
    }
    
    function verifyUser(){
      const uid = document.getElementById('verifyUserId').value.trim();
      if(uid === ""){
        alert("Ingrese el ID del usuario a verificar.");
        return;
      }
      firebase.database().ref('users/' + uid).update({ isVerified: true })
        .then(() => { 
          alert("Usuario marcado como verificado."); 
          document.getElementById('verifyUserId').value = "";
        })
        .catch(error => { console.error("Error al verificar usuario:", error); });
    }
    
    function loadVerifiedUsers(){
      const usersRef = firebase.database().ref('users');
      usersRef.orderByChild('isVerified').equalTo(true).on('value', snapshot => {
        const verifiedList = document.getElementById('verifiedUsersList');
        verifiedList.innerHTML = "<h3 class='text-lg font-bold mb-2'>Usuarios Verificados</h3>";
        snapshot.forEach(child => {
          const user = child.val();
          const div = document.createElement('div');
          div.className = "p-2 bg-green-100 rounded";
          div.innerHTML = `<p><strong>${user.username}</strong> (${child.key})</p>`;
          verifiedList.appendChild(div);
        });
      });
    }
    
    function loadAuthorsForStories(){
      const storiesRef = firebase.database().ref('stories');
      storiesRef.on('value', snapshot => {
        const authorsList = document.getElementById('authorsList');
        let authors = {};
        snapshot.forEach(child => {
          const story = child.val();
          if(story.userId){
            authors[story.userId] = story.username || "Sin nombre";
          }
        });
        authorsList.innerHTML = "";
        for(const uid in authors){
          const div = document.createElement('div');
          div.className = "card flex justify-between items-center";
          div.innerHTML = `<span><strong>${authors[uid]}</strong> (${uid})</span>
                           <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ manageStories('${uid}', '${authors[uid]}'); })">
                             <i class="fas fa-book mr-1"></i> Ver Historias
                           </button>`;
          authorsList.appendChild(div);
        }
      });
    }
    
    function manageStories(userId, username){
      currentAuthorForStories = userId;
      document.getElementById('modalAuthorName').innerText = "Historias de " + username;
      showSpinner();
      firebase.database().ref('stories').orderByChild('userId').equalTo(userId).once('value')
        .then(snapshot => {
          const modalList = document.getElementById('authorStoriesList');
          modalList.innerHTML = "";
          snapshot.forEach(child => {
            const story = child.val();
            const storyDiv = document.createElement('div');
            storyDiv.className = "card flex justify-between items-center";
            storyDiv.innerHTML = `<div>
                                    <p class="font-bold">${story.title}</p>
                                    <p class="text-sm">${new Date(story.createdAt).toLocaleString()}</p>
                                    <p class="text-sm">${story.synopsis || ""}</p>
                                  </div>
                                  <button class="bg-red-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ blockStory('${child.key}'); })">
                                    <i class="fas fa-ban mr-1"></i> Bloquear
                                  </button>`;
            modalList.appendChild(storyDiv);
          });
          hideSpinner();
          document.getElementById('storiesModal').classList.remove('hidden');
        })
        .catch(error => {
          console.error("Error al cargar historias:", error);
          hideSpinner();
        });
    }
    
    function closeStoriesModal(){
      document.getElementById('storiesModal').classList.add('hidden');
    }
    
    /********** NUEVA FUNCIONALIDAD: PERFIL DEL ADMINISTRADOR **********/
    function initializeAdminProfile() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const profileRef = firebase.database().ref('adminProfiles/' + user.uid);
      profileRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          profileRef.set({
            email: user.email,
            photoURL: "https://via.placeholder.com/150",
            points: 0,
            lastDeposit: Date.now()
          });
        }
      });
    }
    
    function loadAdminProfile() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const profileRef = firebase.database().ref('adminProfiles/' + user.uid);
      profileRef.on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          document.getElementById('adminProfilePic').src = data.photoURL || "https://via.placeholder.com/150";
          document.getElementById('adminProfileEmail').textContent = data.email || "";
          document.getElementById('adminProfilePoints').textContent = data.points || 0;
        }
      });
    }
    
    function updateAdminPhotoFromOriginal() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      firebase.database().ref('users').orderByChild('email').equalTo(user.email).once('value')
        .then(snapshot => {
          snapshot.forEach(child => {
            const data = child.val();
            if(data.photoURL) {
              firebase.database().ref('adminProfiles/' + user.uid).update({
                photoURL: data.photoURL
              });
            }
          });
        })
        .catch(error => {
          console.error("Error al obtener la foto de perfil desde la plataforma original:", error);
        });
    }
    
    function checkAndDepositPoints() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const profileRef = firebase.database().ref('adminProfiles/' + user.uid);
      profileRef.once('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          const lastDeposit = data.lastDeposit || 0;
          const now = Date.now();
          const twoDays = 2 * 24 * 60 * 60 * 1000;
          if (now - lastDeposit >= twoDays) {
            const newPoints = (data.points || 0) + 500;
            profileRef.update({
              points: newPoints,
              lastDeposit: now
            }).then(() => {
              console.log("500 puntos depositados automáticamente.");
            }).catch(err => {
              console.error("Error depositando puntos:", err);
            });
          }
        }
      });
    }
    
    /********** FUNCIONES PARA REGALOS LIVE **********/
    // En el admin se podrá subir un regalo para que esté disponible en la plataforma
    document.getElementById('giftForm').addEventListener('submit', function(e){
      e.preventDefault();
      const title = document.getElementById('giftTitle').value;
      const price = parseInt(document.getElementById('giftPrice').value);
      const file = document.getElementById('giftFile').files[0];
      if(!title || file === undefined){
        alert("Completa todos los campos.");
        return;
      }
      // Subir el archivo a Firebase Storage
      const storageRef = firebase.storage().ref();
      const giftRef = storageRef.child('liveGifts/' + file.name);
      giftRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          // Guardar la información del regalo en la base de datos
          const giftData = {
            title: title,
            price: price,
            fileURL: url,
            timestamp: Date.now()
          };
          firebase.database().ref('liveGifts').push(giftData)
            .then(() => { alert("Regalo publicado correctamente."); })
            .catch(err => { console.error("Error al publicar regalo:", err); });
        })
        .catch(err => { console.error("Error al subir archivo de regalo:", err); });
    });
    
    // Función para enviar regalo desde el live (tanto para el transmisor como para el espectador)
    function sendGift(giftType) {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser || currentUser.uid === liveBroadcasterId) {
        alert("No puedes enviar regalos a ti mismo.");
        return;
      }
      firebase.database().ref('users/' + liveBroadcasterId).transaction(userData => {
        if (userData) {
          userData.coins = (userData.coins || 0) + 5;
        }
        return userData;
      }).then(() => {
        let giftUrl = "";
        if(giftType === "mariposas") {
          giftUrl = "https://i.pinimg.com/originals/7c/29/36/7c2936db7563085ef7470d50fd06e4e3.gif";
        } else if(giftType === "ballena") {
          giftUrl = "https://i.pinimg.com/originals/86/31/83/863183316ed35cfeda7baf9ee1de0596.gif";
        }
        // Mostrar animación expandida (como TikTok, en la parte superior o inferior)
        showGiftAnimation(giftUrl, currentUser.displayName || currentUser.email || "Alguien");
      }).catch(error => {
        console.error("Error al enviar regalo:", error);
      });
    }
    
    function showGiftAnimation(giftUrl, senderName) {
      const animContainer = document.getElementById('gift-animation');
      // Se muestra un mensaje estilo "Darell ha enviado una ballena azul" y la animación ocupa la mitad de la pantalla
      animContainer.innerHTML = `
        <div class="absolute bottom-0 w-full" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
          <p class="text-white text-lg text-center p-2">${senderName} ha enviado un regalo</p>
          <div class="flex items-center justify-center">
            <img src="${giftUrl}" alt="Regalo" class="w-48 h-48">
          </div>
        </div>
      `;
      animContainer.classList.add('show');
      setTimeout(() => { animContainer.classList.remove('show'); }, 4000);
    }
    
    /********** FUNCIONES PARA LIVE STREAMING (Autor y Espectador) **********/
    let liveLocalStream = null;
    let livePeerConnection = null;
    let liveBroadcasting = false;
    let currentBroadcasterId = null;
    
    function openLiveStreamModal() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("Debes estar autenticado para transmitir en vivo.");
        return;
      }
      currentBroadcasterId = user.uid;
      document.getElementById('live-stream-modal').classList.remove('hidden');
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          liveLocalStream = stream;
          document.getElementById('live-localVideo').srcObject = stream;
        })
        .catch(err => {
          alert("Error al acceder a la cámara: " + err);
        });
      const profileImg = document.getElementById('profile-image');
      if (profileImg) {
        profileImg.classList.add('live-border');
      }
      // Ocultar el botón de transmitir una vez iniciado
      document.getElementById('live-startBtn').style.display = "none";
    }
    
    function closeLiveStreamModal() {
      document.getElementById('live-stream-modal').classList.add('hidden');
      if (liveLocalStream) {
        liveLocalStream.getTracks().forEach(track => track.stop());
        liveLocalStream = null;
      }
      if (liveBroadcasting) {
        endLiveStream();
      }
      const profileImg = document.getElementById('profile-image');
      if (profileImg) {
        profileImg.classList.remove('live-border');
      }
      // Mostrar nuevamente el botón de iniciar transmisión
      document.getElementById('live-startBtn').style.display = "block";
    }
    
    function startLiveCountdown(duration, callback) {
      let remaining = duration;
      const countdownEl = document.getElementById('live-countdown');
      countdownEl.textContent = remaining;
      const interval = setInterval(() => {
        remaining--;
        if (remaining > 0) {
          countdownEl.textContent = remaining;
        } else {
          clearInterval(interval);
          countdownEl.textContent = "";
          callback();
        }
      }, 1000);
    }
    
    document.getElementById('live-startBtn').addEventListener('click', () => {
      startLiveCountdown(10, () => {
        document.getElementById('live-indicator').classList.remove('hidden');
        document.getElementById('live-endBtn').classList.remove('hidden');
        startBroadcasting();
      });
    });
    
    function startBroadcasting() {
      livePeerConnection = new RTCPeerConnection();
      liveLocalStream.getTracks().forEach(track => {
        livePeerConnection.addTrack(track, liveLocalStream);
      });
      livePeerConnection.onicecandidate = event => {
        if (event.candidate) {
          firebase.database().ref(`liveStreams/${currentBroadcasterId}/candidates`).push(event.candidate.toJSON());
        }
      };
      livePeerConnection.createOffer().then(offer => {
        return livePeerConnection.setLocalDescription(offer).then(() => offer);
      }).then(offer => {
        firebase.database().ref(`liveStreams/${currentBroadcasterId}`).set({
          isLive: true,
          offer: offer,
          views: 0
        });
        liveBroadcasting = true;
        firebase.database().ref(`followers/${currentBroadcasterId}`).once('value').then(snapshot => {
          snapshot.forEach(child => {
            const followerId = child.key;
            firebase.database().ref('users/' + currentBroadcasterId).once('value').then(userSnap => {
              const username = userSnap.val().username;
              addNotification(followerId, `${username} está transmitiendo en vivo`);
            });
          });
        });
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/answer`).on('value', snapshot => {
          const answer = snapshot.val();
          if (answer && livePeerConnection && !livePeerConnection.remoteDescription) {
            livePeerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          }
        });
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/viewerCandidates`).on('child_added', snapshot => {
          const candidate = snapshot.val();
          if (candidate && livePeerConnection) {
            livePeerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          }
        });
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/views`).on('value', snapshot => {
          const views = snapshot.val() || 0;
          document.getElementById('live-viewCount').textContent = views + " vistas";
        });
      });
    }
    
    function endLiveStream() {
      if (livePeerConnection) {
        livePeerConnection.close();
        livePeerConnection = null;
      }
      firebase.database().ref(`liveStreams/${currentBroadcasterId}`).remove();
      liveBroadcasting = false;
      const profileImg = document.getElementById('profile-image');
      if (profileImg) {
        profileImg.classList.remove('live-border');
      }
      setTimeout(() => {
        closeLiveStreamModal();
      }, 3000);
    }
    
    document.getElementById('live-endBtn').addEventListener('click', () => {
      endLiveStream();
    });
    
    function openLiveViewModal(broadcasterId) {
      liveBroadcasterId = broadcasterId;
      document.getElementById('live-view-modal').classList.remove('hidden');
      firebase.database().ref(`liveStreams/${broadcasterId}/views`).transaction(current => (current || 0) + 1);
      const viewerPC = new RTCPeerConnection();
      viewerPC.onicecandidate = event => {
        if (event.candidate) {
          firebase.database().ref(`liveStreams/${broadcasterId}/viewerCandidates`).push(event.candidate.toJSON());
        }
      };
      viewerPC.ontrack = event => {
        document.getElementById('live-remoteVideo').srcObject = event.streams[0];
      };
      firebase.database().ref(`liveStreams/${broadcasterId}/offer`).once('value').then(snapshot => {
        const offer = snapshot.val();
        if (!offer) {
          alert("El autor no está transmitiendo.");
          closeLiveViewModal();
          return;
        }
        viewerPC.setRemoteDescription(new RTCSessionDescription(offer))
          .then(() => viewerPC.createAnswer())
          .then(answer => viewerPC.setLocalDescription(answer).then(() => answer))
          .then(answer => {
            firebase.database().ref(`liveStreams/${broadcasterId}/answer`).set(answer);
          });
      });
      firebase.database().ref(`liveStreams/${broadcasterId}`).on('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('live-endedMessage').classList.remove('hidden');
          setTimeout(closeLiveViewModal, 3000);
        }
      });
      window.currentViewerPC = viewerPC;
    }
    
    function closeLiveViewModal() {
      document.getElementById('live-view-modal').classList.add('hidden');
      document.getElementById('live-endedMessage').classList.add('hidden');
      if (window.currentViewerPC) {
        window.currentViewerPC.close();
        window.currentViewerPC = null;
      }
    }
    
    document.getElementById('live-view-closeBtn').addEventListener('click', closeLiveViewModal);
    
    /********** FUNCIONES PARA COMPARTIR PERFIL **********/
    function shareProfile() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("No estás autenticado.");
        return;
      }
      const profileLink = window.location.origin + window.location.pathname + "#profile/" + user.uid;
      navigator.clipboard.writeText(profileLink)
        .then(() => { alert("Enlace copiado: " + profileLink); })
        .catch(err => { alert("Error al copiar el enlace: " + err); });
    }
    function shareAuthorProfile() {
      if (!currentViewedAuthorId) {
        alert("No hay perfil de autor seleccionado.");
        return;
      }
      const profileLink = window.location.origin + window.location.pathname + "#profile/" + currentViewedAuthorId;
      navigator.clipboard.writeText(profileLink)
        .then(() => { alert("Enlace copiado: " + profileLink); })
        .catch(err => { alert("Error al copiar el enlace: " + err); });
    }
    
    /********** EFECTOS DE CARGA **********/
    function showSpinner(){ document.getElementById('loadingSpinner').style.display = "flex"; }
    function hideSpinner(){ document.getElementById('loadingSpinner').style.display = "none"; }
    
    /********** NOTAS SOBRE MODULOS Y CONSULTAS EN TIEMPO REAL **********/
    // (Aquí se incluyen las funciones de carga de historias, usuarios, etc. según tu código original)
    
    /********** ADMINISTRACIÓN DE CONTENIDO **********/
    // Aquí se incluyen las funciones loadReports, loadSupportRequests, loadBlockedUsers, loadAuthorsForStories, loadVerifiedUsers, etc.
    // (Se han pegado arriba)
    
  </script>
</body>
</html>
