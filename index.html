<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - BeaBoo</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-pap6t+K2bD6xIxQqkQ3sM8e+RXw7C3DyrgXV++o2aL/88+/9kS/l+SmpD8zZR1oN40Nq3QfT7HigDYfFW1zZAQ==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Configuración de Firebase (ajusta según tu proyecto)
    const firebaseConfig = {
      apiKey: "AIzaSyA1UV_OTjRjq22RRB1REnhWzMLZQNCB6wA",
      authDomain: "love-alarm-5c538.firebaseapp.com",
      databaseURL: "https://love-alarm-5c538-default-rtdb.firebaseio.com",
      projectId: "love-alarm-5c538",
      storageBucket: "love-alarm-5c538.appspot.com",
      messagingSenderId: "147543369973",
      appId: "1:147543369973:web:3ef19a73190bce85b27dbc",
      measurementId: "G-VYVPK5VSB5"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: 'Nunito', sans-serif; }
    /* CABECERA FIJA */
    header {
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0.75rem 1rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
    }
    /* Barra de pestañas (navegación horizontal) */
    nav.tabs {
      display: flex;
      overflow-x: auto;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: #f3f4f6;
    }
    nav.tabs button {
      flex: none;
      white-space: nowrap;
    }
    /* Contenedor principal para el dashboard */
    #adminDashboardMain {
      margin-top: 120px; /* espacio para header y pestañas */
    }
    /* Tarjetas (cards) para cada sección */
    .card {
      background-color: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }
    /* Spinner estilo TikTok */
    .spinner-tiktok {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    .spinner-tiktok div {
      position: absolute;
      border: 4px solid #58CC02;
      opacity: 1;
      border-radius: 50%;
      animation: spinner-tiktok 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
    }
    .spinner-tiktok div:nth-child(2) {
      animation-delay: -0.5s;
    }
    @keyframes spinner-tiktok {
      0% { transform: scale(0); }
      50% { transform: scale(1); opacity: 0.5; }
      100% { transform: scale(0); opacity: 0; }
    }
    /* Modal de respuesta (Reply Modal) */
    #replyModal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #replyModal .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    /* Modal para administrar historias de un autor */
    #storiesModal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #storiesModal .modal-content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      width: 95%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    /* Estilo Duolingo para el modal de registro/inicio de sesión */
    .duolingo-modal {
      background: linear-gradient(135deg, #4CAF50, #8BC34A);
      color: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .duolingo-modal input,
    .duolingo-modal button {
      border: none;
      padding: 0.75rem;
      border-radius: 9999px;
      margin-top: 1rem;
    }
    .duolingo-modal input {
      width: 100%;
    }
    .duolingo-modal button {
      background-color: white;
      color: #4CAF50;
      font-weight: bold;
      width: 100%;
    }
    /* Mensaje para historias bloqueadas en la plataforma original */
    .blocked-story {
      background-color: #f2f2f2;
      color: #888;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: bold;
    }
    /* Para que los modales del dashboard se muestren en primer plano */
    #adminDashboard, #adminAuthModal { z-index: 50; }
    
    /* --------------------- NUEVA SECCIÓN: REGALOS LIVE --------------------- */
    /* Nueva pestaña en la barra de tabs */
    nav.tabs button.giftsTabBtn {
      /* Inicialmente con fondo gris (no activa) */
      background-color: #ccc;
      color: #333;
    }
    /* Sección de regalos live en el dashboard */
    #giftsTab {
      padding: 1rem;
    }
    /* Formulario para subir regalo */
    #giftForm input,
    #giftForm button {
      margin-top: 0.75rem;
    }
    /* Contenedor para la lista de regalos */
    #giftList .card {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    /* ------------------------------------------------------------------------- */
  </style>
</head>
<body class="bg-gray-100">
  <!-- PANTALLA DE INTRO Y REGISTRO/LOGIN -->
  <div id="adminIntro" class="min-h-screen flex flex-col items-center justify-center relative">
    <!-- Imagen de fondo similar a tu intro original -->
    <img src="https://ideogram.ai/assets/image/lossless/response/Mj2UkJSlRUi5-nusIdo7CA" alt="Intro" class="absolute inset-0 w-full h-full object-cover opacity-50">
    <div class="duolingo-modal max-w-md mx-auto z-10">
      <h2 class="text-3xl font-bold mb-4 text-center">Bienvenido al Panel de Administración</h2>
      <!-- Formulario de registro (se puede alternar con el de inicio de sesión) -->
      <form id="adminRegisterForm" class="space-y-4">
        <input type="email" id="adminRegEmail" placeholder="Correo electrónico" required>
        <input type="password" id="adminRegPassword" placeholder="Contraseña" required>
        <button type="submit">Registrarse</button>
      </form>
      <p class="mt-4 text-center">
        ¿Ya tienes cuenta? 
        <!-- Se agregó return false para prevenir la acción por defecto -->
        <a href="#" onclick="toggleAdminAuth(event); return false;" class="underline">Inicia sesión</a>
      </p>
    </div>
  </div>
  
  <!-- Modal de inicio de sesión (Duolingo style) -->
  <div id="adminAuthModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="duolingo-modal max-w-md mx-auto">
      <h2 class="text-3xl font-bold mb-4 text-center">Iniciar Sesión</h2>
      <form id="adminAuthForm" class="space-y-4">
        <input type="email" id="adminAuthEmail" placeholder="Correo electrónico" required>
        <input type="password" id="adminAuthPassword" placeholder="Contraseña" required>
        <button type="submit">Iniciar Sesión</button>
      </form>
      <p class="mt-4 text-center">
        ¿No tienes cuenta? 
        <!-- Se agregó return false también aquí -->
        <a href="#" onclick="toggleAdminAuth(event); return false;" class="underline">Regístrate</a>
      </p>
    </div>
  </div>
  
  <!-- DASHBOARD DEL ADMIN (se muestra después del login) -->
  <div id="adminDashboard" class="hidden">
    <!-- CABECERA FIJA -->
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Panel de Administración</h1>
      <button onclick="adminSignOut()" class="bg-red-500 text-white px-3 py-2 rounded flex items-center">
        <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
      </button>
    </header>
    <!-- Barra de pestañas -->
    <nav class="tabs mt-20">
      <button class="admin-tab px-4 py-2 bg-[#58CC02] text-white rounded" onclick="showTab('reports', event)">
        <i class="fas fa-flag mr-1"></i> Reportes
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('support', event)">
        <i class="fas fa-headset mr-1"></i> Soporte
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('users', event)">
        <i class="fas fa-user-slash mr-1"></i> Bloqueados
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('verify', event)">
        <i class="fas fa-check-circle mr-1"></i> Verificación
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('stories', event)">
        <i class="fas fa-book mr-1"></i> Historias
      </button>
      <!-- NUEVA PESTAÑA: REGALOS LIVE -->
      <button class="admin-tab giftsTabBtn px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('gifts', event)">
        <i class="fas fa-gift mr-1"></i> Regalos Live
      </button>
      <button class="admin-tab px-4 py-2 bg-gray-300 text-gray-700 rounded" onclick="showTab('profile', event)">
        <i class="fas fa-user mr-1"></i> Perfil
      </button>
    </nav>
    <!-- Contenido principal del dashboard -->
    <main id="adminDashboardMain" class="container mx-auto px-4">
      <!-- Sección Reportes -->
      <section id="reportsTab" class="admin-tab-content">
        <h2 class="text-2xl font-bold mb-4">Reportes Recibidos</h2>
        <div id="reportsList" class="space-y-4"></div>
      </section>
      <!-- Sección Soporte -->
      <section id="supportTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Solicitudes de Soporte</h2>
        <div id="supportList" class="space-y-4"></div>
      </section>
      <!-- Sección Usuarios Bloqueados -->
      <section id="usersTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Usuarios Bloqueados</h2>
        <div id="blockedUsersList" class="space-y-4"></div>
      </section>
      <!-- Sección Verificación -->
      <section id="verifyTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Verificar Usuario</h2>
        <div class="mb-4">
          <input type="text" id="verifyUserId" placeholder="Ingrese ID del usuario" class="w-full p-3 border rounded">
        </div>
        <button onclick="executeWithSpinner(function(){ verifyUser(); })" class="w-full bg-blue-500 text-white p-3 rounded flex items-center justify-center">
          <i class="fas fa-check-circle mr-2"></i> Marcar como Verificado
        </button>
        <div id="verifiedUsersList" class="mt-6"></div>
      </section>
      <!-- Sección Historias de Autores -->
      <section id="storiesTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Historias por Autor</h2>
        <div id="authorsList" class="space-y-4"></div>
      </section>
      <!-- NUEVA SECCIÓN: REGALOS LIVE -->
      <section id="giftsTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Administrar Regalos Live</h2>
        <!-- Formulario para subir un nuevo regalo -->
        <div class="card mb-4">
          <h3 class="text-xl font-bold mb-2">Subir Nuevo Regalo</h3>
          <form id="giftForm" class="space-y-4">
            <input type="text" id="giftTitle" placeholder="Título del regalo" class="w-full p-3 border rounded">
            <input type="number" id="giftPrice" placeholder="Precio en monedas (0 para gratis)" min="0" class="w-full p-3 border rounded">
            <input type="file" id="giftFile" accept="image/*,video/*,image/svg+xml" class="w-full p-3 border rounded">
            <button type="submit" class="w-full bg-[#58CC02] text-white p-3 rounded flex items-center justify-center">
              <i class="fas fa-upload mr-2"></i> Publicar Regalo
            </button>
          </form>
        </div>
        <!-- Lista de regalos existentes -->
        <div id="giftList" class="space-y-4"></div>
      </section>
      <!-- NUEVA SECCIÓN: PERFIL -->
      <section id="profileTab" class="admin-tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">Perfil del Administrador</h2>
        <div class="card flex flex-col items-center">
          <img id="adminProfilePic" src="https://via.placeholder.com/150" alt="Foto de perfil" class="w-24 h-24 rounded-full mb-4">
          <h3 id="adminProfileEmail" class="text-xl font-bold"></h3>
          <div class="flex items-center mt-2">
            <img src="https://cdn-icons-png.flaticon.com/512/5776/5776691.png" alt="Puntos" class="w-6 h-6 mr-2" />
            <span id="adminProfilePoints" class="text-lg"></span> puntos
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- MODAL DE RESPUESTA (Reply Modal) -->
  <div id="replyModal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">Enviar Respuesta</h2>
      <textarea id="replyMessage" placeholder="Escribe tu respuesta aquí..." class="w-full border p-2 rounded mb-4" rows="5"></textarea>
      <div class="flex justify-end">
        <button onclick="executeWithSpinner(function(){ closeReplyModal(); })" class="mr-4 bg-gray-500 text-white px-4 py-2 rounded flex items-center">
          <i class="fas fa-times-circle mr-1"></i> Cancelar
        </button>
        <button onclick="executeWithSpinner(function(){ sendReply(); })" class="bg-[#58CC02] text-white px-4 py-2 rounded flex items-center">
          <i class="fas fa-paper-plane mr-1"></i> Enviar
        </button>
      </div>
    </div>
  </div>
  
  <!-- MODAL PARA ADMINISTRAR HISTORIAS DE UN AUTOR -->
  <div id="storiesModal" class="hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h2 id="modalAuthorName" class="text-2xl font-bold">Historias de [Autor]</h2>
        <button onclick="executeWithSpinner(function(){ closeStoriesModal(); })" class="text-gray-500 text-3xl">&times;</button>
      </div>
      <div id="authorStoriesList" class="space-y-4"></div>
    </div>
  </div>
  
  <!-- SPINNER DE CARGA (TikTok Style) -->
  <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="spinner-tiktok">
      <div></div>
      <div></div>
    </div>
  </div>
  
  <script>
    /********** VARIABLES GLOBALES **********/
    let replyTargetUser = null;
    let replyContext = "";
    let currentAuthorForStories = null;
    
    /********** FUNCIONES PARA ANIMAR ACCIONES (Spinner) **********/
    function executeWithSpinner(action) {
      showSpinner();
      setTimeout(() => {
        action();
        hideSpinner();
      }, 3000);
    }
    
    function showSpinner(){
      document.getElementById('loadingSpinner').style.display = "flex";
    }
    function hideSpinner(){
      document.getElementById('loadingSpinner').style.display = "none";
    }
    
    /********** UTILIDADES DE ESTILO **********/
    function getVerificationIcon(email) {
      return email === "glamworksapps@gmail.com" 
             ? ' <img src="https://cdn-icons-png.flaticon.com/512/845/845646.png" alt="Verificado" class="inline-block w-4 h-4 ml-1" />'
             : "";
    }
    
    // Se modificó toggleAdminAuth para aceptar el evento y prevenir la acción por defecto
    function toggleAdminAuth(e){
      if(e && e.preventDefault) e.preventDefault();
      const intro = document.getElementById('adminIntro');
      const authModal = document.getElementById('adminAuthModal');
      if(intro.classList.contains('hidden')){
        intro.classList.remove('hidden');
        authModal.classList.add('hidden');
      } else {
        intro.classList.add('hidden');
        authModal.classList.remove('hidden');
      }
    }
    
    // Se cambió event.target por event.currentTarget para asegurar que se aplique el estilo al botón
    function showTab(tabName, event){
      document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.add('hidden'));
      document.getElementById(tabName + "Tab").classList.remove('hidden');
      document.querySelectorAll('.admin-tab').forEach(button => {
        button.classList.remove('bg-[#58CC02]', 'text-white');
        button.classList.add('bg-gray-300', 'text-gray-700');
      });
      event.currentTarget.classList.add('bg-[#58CC02]', 'text-white');
    }
    
    /********** ADMIN LOGIN/REGISTRO **********/
    document.getElementById('adminRegisterForm').addEventListener('submit', function(e){
      e.preventDefault();
      const email = document.getElementById('adminRegEmail').value;
      const password = document.getElementById('adminRegPassword').value;
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          if(
            userCredential.user.email !== "darelvega6@icloud.com" &&
            userCredential.user.email !== "ponsy75@yahoo.com" &&
            userCredential.user.email !== "donovanyaztel1863@gmail.com"
          ){
            alert("Acceso denegado. Solo los administradores autorizados pueden registrarse.");
            firebase.auth().signOut();
            return;
          }
          document.getElementById('adminIntro').classList.add('hidden');
          document.getElementById('adminDashboard').classList.remove('hidden');
          loadReports();
          loadSupportRequests();
          loadBlockedUsers();
          loadAuthorsForStories();
          loadVerifiedUsers();
          initializeAdminProfile();
          loadAdminProfile();
          updateAdminPhotoFromOriginal();
          setInterval(checkAndDepositPoints, 60000);
        })
        .catch(error => {
          alert(error.message);
        });
    });
    
    document.getElementById('adminAuthForm').addEventListener('submit', function(e){
      e.preventDefault();
      const email = document.getElementById('adminAuthEmail').value;
      const password = document.getElementById('adminAuthPassword').value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          if(
            userCredential.user.email !== "darelvega6@icloud.com" &&
            userCredential.user.email !== "ponsy75@yahoo.com" &&
            userCredential.user.email !== "donovanyaztel1863@gmail.com"
          ){
            alert("Acceso denegado. No eres administrador.");
            firebase.auth().signOut();
            return;
          }
          document.getElementById('adminAuthModal').classList.add('hidden');
          document.getElementById('adminDashboard').classList.remove('hidden');
          loadReports();
          loadSupportRequests();
          loadBlockedUsers();
          loadAuthorsForStories();
          loadVerifiedUsers();
          initializeAdminProfile();
          loadAdminProfile();
          updateAdminPhotoFromOriginal();
          setInterval(checkAndDepositPoints, 60000);
        })
        .catch(error => {
          alert(error.message);
        });
    });
    
    function adminSignOut(){
      firebase.auth().signOut().then(() => {
        location.reload();
      });
    }
    
    /********** REPORTES **********/
    function loadReports(){
      const reportsRef = firebase.database().ref('reports');
      reportsRef.on('value', snapshot => {
        const reportsList = document.getElementById('reportsList');
        reportsList.innerHTML = "";
        snapshot.forEach(child => {
          const report = child.val();
          const reportDiv = document.createElement('div');
          reportDiv.className = "card";
          let blockButton = "";
          if(report.reason === "perfil_falso" || (!report.storyId && report.reportedUser)){
            blockButton = `<button class="bg-gray-700 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ blockProfile('${report.reportedUser}'); })">
                             <i class="fas fa-ban mr-1"></i> Bloquear Perfil
                           </button>`;
          } else if(report.storyId){ 
            blockButton = `<button class="bg-gray-700 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ blockStory('${report.storyId}'); })">
                             <i class="fas fa-ban mr-1"></i> Bloquear Historia
                           </button>`;
          }
          reportDiv.innerHTML = `
            <p><strong>Reportado:</strong> ${report.reportedName} <span class="text-sm">(${report.reportedUser})</span></p>
            <p><strong>Reportado por:</strong> ${report.reporterName}</p>
            <p><strong>Motivo:</strong> ${report.reason}</p>
            <p><strong>Descripción:</strong> ${report.description}</p>
            <p><strong>Fecha:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
            <p><strong>Estado:</strong> ${report.status}</p>
            <div class="flex flex-wrap gap-2 mt-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ openReplyModal('${report.reporter}', 'report'); })">
                <i class="fas fa-reply mr-1"></i> Responder
              </button>
              <button class="bg-green-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ updateReportStatus('${child.key}', 'accepted'); })">
                <i class="fas fa-check-circle mr-1"></i> Aceptar
              </button>
              <button class="bg-red-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ updateReportStatus('${child.key}', 'rejected'); })">
                <i class="fas fa-times-circle mr-1"></i> Rechazar
              </button>
              ${blockButton}
            </div>
          `;
          reportsList.appendChild(reportDiv);
        });
      });
    }
    
    function updateReportStatus(reportId, newStatus){
      firebase.database().ref('reports/' + reportId).update({ status: newStatus })
        .then(() => { alert("Reporte actualizado a: " + newStatus); })
        .catch(error => { console.error("Error al actualizar reporte:", error); });
    }
    
    /********** SOPORTE **********/
    function loadSupportRequests(){
      const supportRef = firebase.database().ref('supportRequests');
      supportRef.on('value', snapshot => {
        const supportList = document.getElementById('supportList');
        supportList.innerHTML = "";
        snapshot.forEach(child => {
          const support = child.val();
          const supportDiv = document.createElement('div');
          supportDiv.className = "card";
          supportDiv.innerHTML = `
            <p><strong>Usuario:</strong> ${support.userId}</p>
            <p><strong>Asunto:</strong> ${support.subject}</p>
            <p><strong>Mensaje:</strong> ${support.message}</p>
            <p><strong>Fecha:</strong> ${new Date(support.timestamp).toLocaleString()}</p>
            <p><strong>Estado:</strong> ${support.status}</p>
            <div class="flex flex-wrap gap-2 mt-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ openReplyModal('${support.userId}', 'support'); })">
                <i class="fas fa-reply mr-1"></i> Responder
              </button>
              <button class="bg-green-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ updateSupportStatus('${child.key}', 'resolved'); })">
                <i class="fas fa-heart mr-1"></i> Resuelto
              </button>
            </div>
          `;
          supportList.appendChild(supportDiv);
        });
      });
    }
    
    function updateSupportStatus(requestId, newStatus){
      firebase.database().ref('supportRequests/' + requestId).update({ status: newStatus })
        .then(() => { alert("Soporte actualizado a: " + newStatus); })
        .catch(error => { console.error("Error al actualizar soporte:", error); });
    }
    
    /********** USUARIOS BLOQUEADOS **********/
    function loadBlockedUsers(){
      const usersRef = firebase.database().ref('users');
      usersRef.orderByChild('blocked').equalTo(true).on('value', snapshot => {
        const blockedList = document.getElementById('blockedUsersList');
        blockedList.innerHTML = "";
        snapshot.forEach(child => {
          const user = child.val();
          const userDiv = document.createElement('div');
          userDiv.className = "card";
          userDiv.innerHTML = `
            <p><strong>Usuario:</strong> ${user.username} (${child.key})</p>
            <p><strong>Bloqueado hasta:</strong> ${new Date(user.blockedUntil).toLocaleString()}</p>
            <button class="bg-green-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ unblockUser('${child.key}'); })">
              <i class="fas fa-unlock mr-1"></i> Desbloquear
            </button>
          `;
          blockedList.appendChild(userDiv);
        });
      });
    }
    
    function unblockUser(userId){
      firebase.database().ref('users/' + userId).update({ 
        blocked: false,
        blockedUntil: null
      })
        .then(() => { alert("Usuario desbloqueado"); })
        .catch(error => { console.error("Error al desbloquear usuario:", error); });
    }
    
    /********** BLOQUEAR HISTORIAS Y PERFILES **********/
    function blockStory(storyId){
      if(confirm("¿Seguro que deseas bloquear esta historia? Se desactivará en la plataforma.")){
        firebase.database().ref('stories/' + storyId).update({ 
          blocked: true,
          blockedMessage: "BeaBoo ha bloqueado esta historia por infringir las normas de la comunidad"
        })
          .then(() => { alert("Historia bloqueada."); })
          .catch(error => { console.error("Error al bloquear la historia:", error); });
      }
    }
    
    function blockProfile(userId){
      if(confirm("¿Seguro que deseas bloquear este perfil? El usuario quedará bloqueado en tiempo real.")){
        const blockedUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
        firebase.database().ref('users/' + userId).update({ 
          blocked: true,
          blockedUntil: blockedUntil
        })
          .then(() => { alert("Perfil bloqueado."); })
          .catch(error => { console.error("Error al bloquear el perfil:", error); });
      }
    }
    
    /********** RESPUESTA (Reply Modal) **********/
    function openReplyModal(targetUser, context){
      replyTargetUser = targetUser;
      replyContext = context;
      document.getElementById('replyModal').style.display = "flex";
    }
    function closeReplyModal(){
      document.getElementById('replyModal').style.display = "none";
      document.getElementById('replyMessage').value = "";
      replyTargetUser = null;
      replyContext = "";
    }
    function sendReply(){
      const message = document.getElementById('replyMessage').value;
      if(!replyTargetUser || message.trim() === ""){
        alert("Escribe un mensaje para enviar.");
        return;
      }
      addNotification(replyTargetUser, message);
      alert("Respuesta enviada.");
      closeReplyModal();
    }
    
    function addNotification(userId, message) {
      const notificationsRef = firebase.database().ref('notifications/' + userId);
      const newNotificationRef = notificationsRef.push();
      newNotificationRef.set({
        message: message,
        timestamp: Date.now(),
        read: false
      });
    }
    
    /********** VERIFICACIÓN DE USUARIOS **********/
    function verifyUser(){
      const uid = document.getElementById('verifyUserId').value.trim();
      if(uid === ""){
        alert("Ingrese el ID del usuario a verificar.");
        return;
      }
      firebase.database().ref('users/' + uid).update({ isVerified: true })
        .then(() => { 
          alert("Usuario marcado como verificado."); 
          document.getElementById('verifyUserId').value = "";
        })
        .catch(error => { console.error("Error al verificar usuario:", error); });
    }
    
    function loadVerifiedUsers(){
      const usersRef = firebase.database().ref('users');
      usersRef.orderByChild('isVerified').equalTo(true).on('value', snapshot => {
        const verifiedList = document.getElementById('verifiedUsersList');
        verifiedList.innerHTML = "<h3 class='text-lg font-bold mb-2'>Usuarios Verificados</h3>";
        snapshot.forEach(child => {
          const user = child.val();
          const div = document.createElement('div');
          div.className = "p-2 bg-green-100 rounded";
          div.innerHTML = `<p><strong>${user.username}</strong> (${child.key})</p>`;
          verifiedList.appendChild(div);
        });
      });
    }
    
    /********** HISTORIAS DE AUTORES **********/
    function loadAuthorsForStories(){
      const storiesRef = firebase.database().ref('stories');
      storiesRef.on('value', snapshot => {
        const authorsList = document.getElementById('authorsList');
        let authors = {};
        snapshot.forEach(child => {
          const story = child.val();
          if(story.userId){
            authors[story.userId] = story.username || "Sin nombre";
          }
        });
        authorsList.innerHTML = "";
        for(const uid in authors){
          const div = document.createElement('div');
          div.className = "card flex justify-between items-center";
          div.innerHTML = `<span><strong>${authors[uid]}</strong> (${uid})</span>
                           <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ manageStories('${uid}', '${authors[uid]}'); })">
                             <i class="fas fa-book mr-1"></i> Ver Historias
                           </button>`;
          authorsList.appendChild(div);
        }
      });
    }
    
    function manageStories(userId, username){
      currentAuthorForStories = userId;
      document.getElementById('modalAuthorName').innerText = "Historias de " + username;
      showSpinner();
      firebase.database().ref('stories').orderByChild('userId').equalTo(userId).once('value')
        .then(snapshot => {
          const modalList = document.getElementById('authorStoriesList');
          modalList.innerHTML = "";
          snapshot.forEach(child => {
            const story = child.val();
            const storyDiv = document.createElement('div');
            storyDiv.className = "card flex justify-between items-center";
            storyDiv.innerHTML = `<div>
                                    <p class="font-bold">${story.title}</p>
                                    <p class="text-sm">${new Date(story.createdAt).toLocaleString()}</p>
                                    <p class="text-sm">${story.synopsis || ""}</p>
                                  </div>
                                  <button class="bg-red-500 text-white px-3 py-1 rounded flex items-center" onclick="executeWithSpinner(function(){ blockStory('${child.key}'); })">
                                    <i class="fas fa-ban mr-1"></i> Bloquear
                                  </button>`;
            modalList.appendChild(storyDiv);
          });
          hideSpinner();
          document.getElementById('storiesModal').classList.remove('hidden');
        })
        .catch(error => {
          console.error("Error al cargar historias:", error);
          hideSpinner();
        });
    }
    
    function closeStoriesModal(){
      document.getElementById('storiesModal').classList.add('hidden');
    }
    
    /********** LIVE STREAMING (NUEVA FUNCIÓN) **********/
    let liveLocalStream = null;
    let livePeerConnection = null;
    let liveBroadcasting = false;
    let currentBroadcasterId = null;
    
    function openLiveStreamModal() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("Debes estar autenticado para transmitir en vivo.");
        return;
      }
      currentBroadcasterId = user.uid;
      document.getElementById('live-stream-modal').classList.remove('hidden');
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          liveLocalStream = stream;
          document.getElementById('live-localVideo').srcObject = stream;
        })
        .catch(err => {
          alert("Error al acceder a la cámara: " + err);
        });
      const profileImg = document.getElementById('profile-image');
      if (profileImg) {
        profileImg.classList.add('live-border');
      }
      firebase.database().ref(`liveStreams/${currentBroadcasterId}/gifts`).on('child_added', snapshot => {
          let gift = snapshot.val();
          let giftUrl = "";
          if(gift.giftType === "mariposas") {
             giftUrl = "https://i.pinimg.com/originals/7c/29/36/7c2936db7563085ef7470d50fd06e4e3.gif";
          } else if(gift.giftType === "ballena") {
             giftUrl = "https://i.pinimg.com/originals/86/31/83/863183316ed35cfeda7baf9ee1de0596.gif";
          }
          showGiftAnimation(giftUrl, gift.senderName);
          snapshot.ref.remove();
      });
    }
    
    function closeLiveStreamModal() {
      document.getElementById('live-stream-modal').classList.add('hidden');
      if (liveLocalStream) {
        liveLocalStream.getTracks().forEach(track => track.stop());
        liveLocalStream = null;
      }
      if (liveBroadcasting) {
        endLiveStream();
      }
      const profileImg = document.getElementById('profile-image');
      if (profileImg) {
        profileImg.classList.remove('live-border');
      }
    }
    
    function startLiveCountdown(duration, callback) {
      let remaining = duration;
      const countdownEl = document.getElementById('live-countdown');
      countdownEl.textContent = remaining;
      const interval = setInterval(() => {
        remaining--;
        if (remaining > 0) {
          countdownEl.textContent = remaining;
        } else {
          clearInterval(interval);
          countdownEl.textContent = "";
          callback();
        }
      }, 1000);
    }
    
    document.getElementById('live-startBtn').addEventListener('click', () => {
      startLiveCountdown(10, () => {
        document.getElementById('live-indicator').classList.remove('hidden');
        document.getElementById('live-startBtn').classList.add('hidden');
        document.getElementById('live-endBtn').classList.remove('hidden');
        startBroadcasting();
      });
    });
    
    function startBroadcasting() {
      livePeerConnection = new RTCPeerConnection();
      liveLocalStream.getTracks().forEach(track => {
        livePeerConnection.addTrack(track, liveLocalStream);
      });
      livePeerConnection.onicecandidate = event => {
        if (event.candidate) {
          firebase.database().ref(`liveStreams/${currentBroadcasterId}/candidates`).push(event.candidate.toJSON());
        }
      };
      livePeerConnection.createOffer().then(offer => {
        return livePeerConnection.setLocalDescription(offer).then(() => offer);
      }).then(offer => {
        firebase.database().ref(`liveStreams/${currentBroadcasterId}`).set({
          isLive: true,
          offer: offer,
          views: 0
        });
        liveBroadcasting = true;
        firebase.database().ref(`followers/${currentBroadcasterId}`).once('value').then(snapshot => {
          snapshot.forEach(child => {
            const followerId = child.key;
            firebase.database().ref('users/' + currentBroadcasterId).once('value').then(userSnap => {
              const username = userSnap.val().username;
              addNotification(followerId, `${username} está transmitiendo en vivo`);
            });
          });
        });
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/answer`).on('value', snapshot => {
          const answer = snapshot.val();
          if (answer && livePeerConnection && !livePeerConnection.remoteDescription) {
            livePeerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          }
        });
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/viewerCandidates`).on('child_added', snapshot => {
          const candidate = snapshot.val();
          if (candidate && livePeerConnection) {
            livePeerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          }
        });
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/views`).on('value', snapshot => {
          const views = snapshot.val() || 0;
          document.getElementById('live-viewCount').textContent = views + " vistas";
        });
      });
    }
    
    function endLiveStream() {
      if (livePeerConnection) {
        livePeerConnection.close();
        livePeerConnection = null;
      }
      firebase.database().ref(`liveStreams/${currentBroadcasterId}`).remove();
      liveBroadcasting = false;
      const profileImg = document.getElementById('profile-image');
      if (profileImg) {
        profileImg.classList.remove('live-border');
      }
      setTimeout(() => {
        closeLiveStreamModal();
      }, 3000);
    }
    
    document.getElementById('live-endBtn').addEventListener('click', () => {
      endLiveStream();
    });
    
    function openLiveViewModal(broadcasterId) {
      liveBroadcasterId = broadcasterId;
      document.getElementById('live-view-modal').classList.remove('hidden');
      firebase.database().ref(`liveStreams/${broadcasterId}/views`).transaction(current => (current || 0) + 1);
      const viewerPC = new RTCPeerConnection();
      viewerPC.onicecandidate = event => {
        if (event.candidate) {
          firebase.database().ref(`liveStreams/${broadcasterId}/viewerCandidates`).push(event.candidate.toJSON());
        }
      };
      viewerPC.ontrack = event => {
        document.getElementById('live-remoteVideo').srcObject = event.streams[0];
      };
      firebase.database().ref(`liveStreams/${broadcasterId}/offer`).once('value').then(snapshot => {
        const offer = snapshot.val();
        if (!offer) {
          alert("El autor no está transmitiendo.");
          closeLiveViewModal();
          return;
        }
        viewerPC.setRemoteDescription(new RTCSessionDescription(offer))
          .then(() => viewerPC.createAnswer())
          .then(answer => viewerPC.setLocalDescription(answer).then(() => answer))
          .then(answer => {
            firebase.database().ref(`liveStreams/${broadcasterId}/answer`).set(answer);
          });
      });
      firebase.database().ref(`liveStreams/${broadcasterId}`).on('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('live-endedMessage').classList.remove('hidden');
          setTimeout(closeLiveViewModal, 3000);
        }
      });
      window.currentViewerPC = viewerPC;
    }
    
    function closeLiveViewModal() {
      document.getElementById('live-view-modal').classList.add('hidden');
      document.getElementById('live-endedMessage').classList.add('hidden');
      if (window.currentViewerPC) {
        window.currentViewerPC.close();
        window.currentViewerPC = null;
      }
    }
    
    document.getElementById('live-view-closeBtn').addEventListener('click', closeLiveViewModal);
    
    /********** FUNCIONES DE REGALOS EN LIVE (USUARIO ESPECTADOR) **********/
    document.getElementById('gift-btn').addEventListener('click', () => {
      document.getElementById('gift-drawer').classList.add('open');
    });
    function closeGiftDrawer() {
      document.getElementById('gift-drawer').classList.remove('open');
    }
    function sendGift(giftType) {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser || currentUser.uid === liveBroadcasterId) {
        alert("No puedes enviar regalos a ti mismo.");
        return;
      }
      let giftData = {
        giftType: giftType,
        senderName: currentUser.displayName || currentUser.email || "Alguien",
        timestamp: Date.now()
      };
      firebase.database().ref(`liveStreams/${liveBroadcasterId}/gifts`).push(giftData);
      closeGiftDrawer();
    }
    function showGiftAnimation(giftUrl, senderName) {
      const transmitBtn = document.getElementById('live-startBtn');
      if(transmitBtn) transmitBtn.style.display = 'none';
      const animContainer = document.getElementById('gift-animation');
      animContainer.innerHTML = `
        <div class="text-center">
          <p class="text-white text-xl mb-2">${senderName} ha enviado un regalo</p>
          <img src="${giftUrl}" alt="Regalo" class="mx-auto" style="max-width: 100%; max-height: 100%;">
        </div>`;
      animContainer.classList.add('show');
      setTimeout(() => {
        animContainer.classList.remove('show');
      }, 4000);
    }
    
    /********** EFECTO SKELETON **********/
    function applySkeletonEffect() {
      document.getElementById('profile-image').classList.add('skeleton');
      document.getElementById('profile-username').classList.add('skeleton');
      document.getElementById('profile-bio').classList.add('skeleton');
      const userStories = document.getElementById('user-stories');
      if(userStories) { userStories.classList.add('skeleton'); }
    }
    function removeSkeletonEffect() {
      document.getElementById('profile-image').classList.remove('skeleton');
      document.getElementById('profile-username').classList.remove('skeleton');
      document.getElementById('profile-bio').classList.remove('skeleton');
      const userStories = document.getElementById('user-stories');
      if(userStories) { userStories.classList.remove('skeleton'); }
    }
    if(!navigator.onLine) { applySkeletonEffect(); }
    window.addEventListener('offline', applySkeletonEffect);
    window.addEventListener('online', removeSkeletonEffect);
    
    /********** CARGA DE HISTORIAS **********/
    function loadStories() {
      firebase.database().ref('stories').on('value', snapshot => {
        let stories = [];
        snapshot.forEach(child => { stories.push(child.val()); });
        let newReleases = stories.sort((a, b) => b.createdAt - a.createdAt);
        renderStories(newReleases, 'new-releases', false);
        let top10 = stories.sort((a, b) => b.views - a.views).slice(0, 10);
        renderStories(top10, 'top10', false);
        let popular = stories.sort((a, b) => b.views - a.views);
        renderStories(popular, 'popular', false);
        let terrorStories = stories.filter(story => story.category === 'terror');
        renderStories(terrorStories, 'terror-stories', false);
      });
    }
    function renderStories(stories, elementId, editMode) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      stories.forEach(story => {
        if (story.blocked) return;
        const storyCard = document.createElement('div');
        storyCard.className = 'story-card cursor-pointer relative';
        storyCard.onclick = editMode ? () => openStoryEdit(story) : () => openStoryDetail(story);
        storyCard.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
            <div class="story-cover-container">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image" />
            </div>
          </div>
          <div class="mt-2">
            <h3 class="font-semibold text-sm">${story.title}</h3>
          </div>
        `;
        const languageDiv = document.createElement('div');
        languageDiv.className = "mt-1 flex items-center space-x-2";
        languageDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if(story.rating === "18plus") {
          languageDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        storyCard.appendChild(languageDiv);
        container.appendChild(storyCard);
      });
    }
    
    function loadUserStories(userId) {
      const userStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(userId);
      userStoriesRef.on('value', snapshot => {
        const container = document.getElementById('user-stories');
        container.innerHTML = "";
        snapshot.forEach(child => {
          const story = child.val();
          if (story.blocked) return;
          const card = document.createElement('div');
          card.className = "cursor-pointer";
          card.onclick = () => openStoryEdit(story);
          card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
          const langDiv = document.createElement('div');
          langDiv.className = "mt-1 flex items-center space-x-2";
          langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
          if(story.rating === "18plus") {
            langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
          }
          card.appendChild(langDiv);
          container.appendChild(card);
        });
      });
    }
    
    function loadAuthorStories(authorId) {
      const authorStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(authorId);
      authorStoriesRef.on('value', snapshot => {
        const container = document.getElementById('author-stories');
        container.innerHTML = "";
        snapshot.forEach(child => {
          const story = child.val();
          if (story.blocked) return;
          const card = document.createElement('div');
          card.className = "cursor-pointer";
          card.onclick = () => openStoryDetail(story);
          card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
          const langDiv = document.createElement('div');
          langDiv.className = "mt-1 flex items-center space-x-2";
          langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
          if(story.rating === "18plus") {
            langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
          }
          card.appendChild(langDiv);
          container.appendChild(card);
        });
      });
    }
    
    /********** MODAL REPORTE **********/
    function openReportModal() {
      document.getElementById('author-profile-modal').style.display = "none";
      document.getElementById('report-modal').style.display = "flex";
    }
    function closeReportModal() {
      document.getElementById('report-modal').style.display = "none";
    }
    
    /********** ADMIN PERFIL **********/
    function initializeAdminProfile() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const profileRef = firebase.database().ref('adminProfiles/' + user.uid);
      profileRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          profileRef.set({
            email: user.email,
            photoURL: "https://via.placeholder.com/150",
            points: 0,
            lastDeposit: Date.now()
          });
        }
      });
    }
    
    function loadAdminProfile() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const profileRef = firebase.database().ref('adminProfiles/' + user.uid);
      profileRef.on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          document.getElementById('adminProfilePic').src = data.photoURL || "https://via.placeholder.com/150";
          document.getElementById('adminProfileEmail').textContent = data.email || "";
          document.getElementById('adminProfilePoints').textContent = data.points || 0;
        }
      });
    }
    
    function updateAdminPhotoFromOriginal() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      firebase.database().ref('users').orderByChild('email').equalTo(user.email).once('value')
        .then(snapshot => {
          snapshot.forEach(child => {
            const data = child.val();
            if(data.photoURL) {
              firebase.database().ref('adminProfiles/' + user.uid).update({
                photoURL: data.photoURL
              });
            }
          });
        })
        .catch(error => {
          console.error("Error al obtener la foto de perfil desde la plataforma original:", error);
        });
    }
    
    function checkAndDepositPoints() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const profileRef = firebase.database().ref('adminProfiles/' + user.uid);
      profileRef.once('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          const lastDeposit = data.lastDeposit || 0;
          const now = Date.now();
          const twoDays = 2 * 24 * 60 * 60 * 1000;
          if (now - lastDeposit >= twoDays) {
            const newPoints = (data.points || 0) + 500;
            profileRef.update({
              points: newPoints,
              lastDeposit: now
            }).then(() => {
              console.log("500 puntos depositados automáticamente.");
            }).catch(err => {
              console.error("Error depositando puntos:", err);
            });
          }
        }
      });
    }
    
    /********** HISTORIAS DE AUTORES **********/
    // (Funciones loadAuthorsForStories, manageStories, closeStoriesModal ya definidas más arriba)
    
    /********** NUEVA SECCIÓN: REGALOS LIVE (ADMIN) **********/
    // Publicar un nuevo regalo live
    function publishGift() {
      const title = document.getElementById('giftTitle').value.trim();
      const price = parseInt(document.getElementById('giftPrice').value);
      const fileInput = document.getElementById('giftFile');
      if(!title) {
        alert("Por favor, ingresa el título del regalo.");
        return;
      }
      if(isNaN(price)) {
        alert("Por favor, ingresa un precio válido.");
        return;
      }
      if(fileInput.files.length === 0) {
        alert("Por favor, selecciona un archivo para el regalo.");
        return;
      }
      const file = fileInput.files[0];
      const storageRef = firebase.storage().ref();
      // Usamos la fecha y el nombre del archivo para crear un identificador único
      const giftRef = storageRef.child('liveGifts/' + Date.now() + '_' + file.name);
      const uploadTask = giftRef.put(file);
      uploadTask.on('state_changed', 
        function progress(snapshot) {
          // Puedes agregar feedback de progreso aquí si lo deseas
        },
        function error(err) {
          alert("Error al subir el regalo: " + err.message);
        },
        function complete() {
          uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
            const giftData = {
              title: title,
              price: price,
              fileUrl: downloadURL,
              fileType: file.type,
              timestamp: Date.now()
            };
            firebase.database().ref('liveGifts').push(giftData)
              .then(() => {
                alert("Regalo publicado correctamente.");
                document.getElementById('giftForm').reset();
              })
              .catch(err => {
                alert("Error al publicar el regalo: " + err.message);
              });
          });
        }
      );
    }
    
    document.getElementById('giftForm').addEventListener('submit', function(e) {
      e.preventDefault();
      publishGift();
    });
    
    // Escuchar cambios en "liveGifts" para mostrar la lista en el dashboard
    firebase.database().ref('liveGifts').on('value', function(snapshot) {
      const giftListDiv = document.getElementById('giftList');
      giftListDiv.innerHTML = "";
      snapshot.forEach(function(childSnapshot) {
        const gift = childSnapshot.val();
        const giftKey = childSnapshot.key;
        const div = document.createElement('div');
        div.className = "card flex items-center justify-between";
        let previewHtml = "";
        if(gift.fileType.startsWith("image/")){
          previewHtml = `<img src="${gift.fileUrl}" alt="${gift.title}" class="w-16 h-16 object-cover rounded">`;
        } else if(gift.fileType.startsWith("video/")){
          previewHtml = `<video src="${gift.fileUrl}" class="w-16 h-16 rounded" autoplay muted loop></video>`;
        } else {
          previewHtml = `<span>Archivo</span>`;
        }
        div.innerHTML = `
          <div class="flex items-center space-x-4">
            ${previewHtml}
            <div>
              <p class="font-bold">${gift.title}</p>
              <p class="text-sm">${gift.price === 0 ? "Gratis" : gift.price + " monedas"}</p>
            </div>
          </div>
          <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteGift('${giftKey}')">
            <i class="fas fa-trash"></i>
          </button>
        `;
        giftListDiv.appendChild(div);
      });
    });
    
    function deleteGift(giftKey) {
      if(confirm("¿Estás seguro de que deseas eliminar este regalo?")) {
        firebase.database().ref('liveGifts/' + giftKey).remove()
          .then(() => { alert("Regalo eliminado."); })
          .catch(err => { alert("Error al eliminar el regalo: " + err.message); });
      }
    }
    
    /********** FUNCIONES PARA COMPARTIR PERFIL **********/
    // (Funciones shareProfile y shareAuthorProfile ya definidas)
    
    /********** RESTO DE CÓDIGO (historias, capítulos, etc.) **********/
    // (Se mantienen sin cambios)
    
  </script>
</body>
</html>
